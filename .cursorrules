You are an expert AI coding assistant.

# ðŸš¨ CRITICAL: Start Here First

**BEFORE starting ANY task, you MUST:**

1. **Read `docs/CONTEXT_MAP.md`** - This maps all concepts to their source files and saves you from searching
2. **Check `docs/ARCHITECTURE.md`** - Understand the system architecture and data flow
3. **Review relevant docs** - Check `docs/` for task-specific guides (AUTOMATED_TESTING.md, DEBUGGING.md, etc.)

**DO NOT** start searching or grepping the codebase until you've consulted these documents.

## ðŸ“ Quick Reference

- **Pages**: `src/app/[locale]/[page-name]/page.tsx` (e.g., `/en/about`, `/de/create`)
- **Translations**: `messages/{en,de,pl,da}.json` - Update ALL locales together
- **Components**: `src/components/` (shared) or colocated with pages
- **Core Logic**: `src/lib/` (routeGenerator.ts, geoUtils.ts, imageProcessing.ts)

# Pre-Deployment Checks

Before pushing any changes to GitHub (especially to the main branch), you MUST run the following checks locally to ensure they pass:

1. **Security Audit**
   ```bash
   npm audit --audit-level=high
   ```
   This check ensures there are no high-severity security vulnerabilities in dependencies.

2. **Linting**
   ```bash
   npm run lint
   ```
   This runs ESLint to catch code quality issues, TypeScript errors, and security-related linting rules.

3. **Tests**
   ```bash
   npm test
   ```
   This runs the test suite to ensure all tests pass.

**CRITICAL**: If any of these checks fail, you MUST fix the issues before pushing to GitHub. Pushing code that fails these checks will cause the CI/CD pipeline to fail and block deployment.

# Workflow

When making changes:
1. Make your code changes
2. Run all three pre-deployment checks
3. Fix any issues that arise
4. Complete post-work verification (tests, README, documentation)
5. Only then proceed with `git add`, `git commit`, and `git push`

# Post-Work Verification Rules
After completing any coding task, you MUST perform the following steps:

1.  **Run All Tests**:
    - Execute the full test suite for the project.
    - Ensure all tests pass.
    - If any tests fail, you MUST fix the failures before considering the task complete.

2.  **Check README.md**:
    - Review `README.md` to see if it needs to be updated with any new information related to the changes you made.
    - **Length Constraint**: Ensure `README.md` is NOT longer than 200 lines. If it exceeds this limit, condense the content while retaining essential information.

3.  **Update Documentation & Comments**:
    - **Architecture**: If you changed data flow or core components, update `docs/ARCHITECTURE.md`.
    - **Debugging**: If you added new external dependencies or complex logic, update `docs/DEBUGGING.md`.
    - **JSDoc**: Ensure all new or modified exported functions in `src/lib` have accurate JSDoc comments.

# Internationalization (i18n) Rules

When modifying any user-facing text:
- **Update ALL locale files**: `messages/en.json`, `messages/de.json`, `messages/pl.json`, `messages/da.json`
- Translation structure mirrors page names: `HomePage`, `AboutPage`, `CreatePage`, etc.
- Test changes across all locales before deploying (at minimum check one non-English locale)
- Never commit changes to only one locale file

# Tech Stack & Constraints
- **Framework**: Next.js 16 (App Router)
- **Styling**: Tailwind CSS 4
- **Maps**: React-Leaflet / Leaflet
- **Testing**: Vitest
- **Deployment**: Firebase Hosting
- **Internationalization**: next-intl (static export compatible)

# Coding Style
- **Components**: Use functional components with hooks. Prefer small, focused components.
- **Icons**: Use `lucide-react` for icons.
- **Logic**: Ensure all geometric calculations in `src/lib` have unit tests.
- **State**: Keep state local where possible, lift up only when necessary.
- **Type Safety**: Use TypeScript strictly. Avoid `any`.

# Critical Context for Agents

## ðŸ§ª Testing & Automation
- **NO FILE PICKERS**: You cannot interact with OS file dialogs.
- **USE HELPERS**: For image upload tests, use `window.__routistaTestHelpers.loadTestImage("star.png")` or `loadImageFromDataURL()`.
- **CONTROLS**: Interact with hidden test elements using `data-testid` (e.g., `test-load-star`, `upload-next-button`).
- **REFERENCE**: See `docs/AUTOMATED_TESTING.md` for the complete automation protocol.

## ðŸ—ºï¸ Codebase Navigation
- **MAP**: Read `docs/CONTEXT_MAP.md` FIRST to find the right files for your task.
- **LOGIC**:
  - Routing -> `src/lib/routeGenerator.ts`
  - Geometry -> `src/lib/geoUtils.ts`
  - Image Proc -> `src/lib/imageProcessing.ts`

# Additional Notes
- The GitHub Actions security workflow runs the pre-deployment checks
- Catching issues locally saves time and prevents broken builds
- Always verify that tests pass before considering work complete
